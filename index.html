<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Form Pengajuan Layanan ‚Äî Mobil Layanan Umat (Mobile)</title>
<meta name="description" content="Form pengajuan layanan Mobil Layanan Umat PCM Wonotunggal. Mobile-first, kirim via WhatsApp."/>
<style>
  :root{
    --bg:#ffffff;
    --muted:#6b7580;
    --accent-orange:#ff8a4b;
    --accent-blue:#1273de;
    --field-bg:#f6fbff;
    --radius:12px;
    --shadow: 0 12px 30px rgba(6,24,48,0.08);
    font-family: Inter, 'Segoe UI', monttserrat, system-ui, -apple-system, 'Helvetica Neue', Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:#072138;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:12px}
  .wrap{width:100%;max-width:640px}

  /* HERO (blue solid, left-aligned text, logo right) */
  .hero{
    width:100%; border-radius:12px; overflow:hidden; background:var(--accent-blue);
    height:24vh; min-height:110px; max-height:200px; display:flex; align-items:center; padding:16px; position:relative; box-shadow:var(--shadow)
  }
  .hero-left{flex:1;color:#fff; align-self:center; text-align:left}
  .hero-left .small{font-size:13px;font-weight:800;opacity:0.98}
  .hero-left .big{font-size:22px;font-weight:900; margin-top:6px}
  .hero-left .sub{font-size:14px;margin-top:8px;font-weight:700;opacity:0.95}
  .hero-right{position:absolute; right:12px; top:12px}
  .hero-right img{width:56px;height:56px;object-fit:contain;border-radius:8px;background:#fff;padding:6px;box-shadow:0 10px 28px rgba(2,6,23,0.12)}

  /* card */
  .card{margin-top:-18px;background:#fff;border-radius:12px;padding:14px;width:100%;box-shadow:0 12px 36px rgba(6,24,48,0.06);display:grid;gap:12px}

  /* fields */
  .field{display:flex;gap:12px;align-items:flex-start;padding:14px;border-radius:14px;background:var(--field-bg);border:1px solid rgba(18,115,222,0.08);transition:box-shadow .12s, transform .12s}
  .field:focus-within{box-shadow:0 14px 30px rgba(18,115,222,0.08);transform:translateY(-2px);border-color:rgba(18,115,222,0.18)}
  .icon{width:44px;height:44px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.45)}
  .icon svg{width:22px;height:22px}
  .control{flex:1}
  label{display:block;font-size:14px;color:#0b2b3a;font-weight:800;margin-bottom:8px}
  input[type=text], input[type=tel], input[type=number], input[type=date], input[type=time], select, textarea{
    width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(11,43,58,0.06);background:#fff;font-size:16px;color:#072138;outline:none;
  }
  textarea{min-height:100px;resize:vertical}
  input::placeholder, textarea::placeholder{color:#9aa4b2}
  .muted{color:var(--muted);font-size:14px}

  /* category / dynamic select */
  .inline-row{display:flex;gap:8px}
  .inline-row .col{flex:1}

  /* buttons */
  .actions{display:flex;gap:16px;margin-top:8px}
  .btn{padding:14px;border-radius:12px;border:none;font-weight:900;cursor:pointer;font-size:15px}
  .btn-primary{flex-grow:1;background: #f7931e;color:#fff;box-shadow:0 12px 26px rgba(247,147,30,0.35)}
  .btn-ghost{background:#fff;margin-left:auto;flex-shrink:0;border:1px solid rgba(11,43,58,0.06);color:var(--muted);padding:12px 14px;border-radius:12px}

  /* popup */
  .popup{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(2,6,23,0.45);z-index:120;padding:12px;overflow-y:auto}
  .popup.show{display:flex}
  .modal{width:100%;max-width:460px;max-height:85vh;box-sizing:border-box;background:#fff;border-radius:12px;padding:14px;box-shadow:0 20px 50px rgba(2,6,23,0.28)}
  .summary{margin-top:8px;max-height:45vh;background:rgba(18,115,222,0.04);padding:6px;border-radius:8px;font-size:14px;color:#07324;overflow-y:auto}

  /* toast */
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#f0fff4;border-left:6px solid #28a745;padding:12px 14px;border-radius:10px;display:none;z-index:130;font-weight:800}
  .toast.show{display:block}

  /* footer */
  footer{
  margin-top:20px;
  text-align:center;
  color:var(--muted);
  font-size:13px;
}

/* sponsor grid */
.sponsors{
  display:grid;
  grid-template-columns:repeat(5, 1fr);
  gap:14px;
  align-items:center;
  margin-top:12px;
}

/* sponsor card */
.sponsor-slot{
  height:72px;
  background:#fff;
  border:1.5px solid #cfe0ff;
  border-radius:14px;

  display:flex;
  align-items:center;
  justify-content:center;

  padding:10px;
  transition:all .15s ease;
}

.sponsor-slot img{
  max-height:44px;
  max-width:100%;
  object-fit:contain;
}

.sponsor-slot:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 22px rgba(18,115,222,0.12);
}

/* tablet */
@media (max-width:768px){
  .sponsors{
    grid-template-columns:repeat(3, 1fr);
  }
}

/* mobile */
@media (max-width:420px){
  .sponsors{
    grid-template-columns:repeat(2, 1fr);
  }

  .sponsor-slot{
    height:68px;
  }

  .sponsor-slot img{
    max-height:40px;
  }
}
.info-box{
  margin-top:12px;
  padding:12px;
  border-radius:10px;
  background:#fffbe6;
  border:1px solid #ffe58f;
  font-size:14px;
  color:#5c4a00;
}

.info-title{
  font-weight:900;
  margin-bottom:6px;
}

.info-text ol{
  padding-left:18px;
  margin:6px 0;
}

.info-text li{
  margin-bottom:4px;
}

.info-note{
  margin-top:8px;
  font-size:13px;
  color:#6b5a00;
}
.summary-section{
  padding:12px;
  border-radius:10px;
  background:#f7fafc;
  margin-bottom:12px;
}

.summary-title{
  font-weight:900;
  color:#0b3a6a;
  margin-bottom:6px;
}

.summary-item{
  margin-bottom:4px;
  font-size:14px;
  color:#07324a;
}
/* Pernyataan & Persetujuan */
.persetujuan-box{
  margin-top:14px;
  padding:14px;
  border-radius:12px;
  background:linear-gradient(135deg,#fff7e6,#ffe7ba);
  border:1px solid #ffd591;
  color:#7a4a00;
}

.persetujuan-box label{
  font-size:14px;
  line-height:1.6;
  cursor:pointer;
}

.persetujuan-box input[type="checkbox"]{
  transform:scale(1.2);
  margin-right:6px;
}

.persetujuan-box a{
  color:#d46b08;
  text-decoration:none;
}

.persetujuan-box a:hover{
  text-decoration:underline;
}
.btn-reset{
  background:#f1f3f5;
  color:#555;
  border:1px solid #d9d9d9;
}

.btn-reset:hover{
  background:#e9ecef;
}

  /* Mobile-friendly tweaks */
  @media (max-width:420px){
    body{padding:10px}
    .hero{height:20vh;padding:12px}
    .hero-left .big{font-size:18px}
    .icon{width:44px;height:44px}
    .field{padding:12px;gap:10px;border-radius:12px}
    label{font-size:13px}
    input,select,textarea{font-size:15px;padding:11px 12px}
    .btn{font-size:15px;padding:12px;border-radius:12px}
    .hero-right img{width:48px;height:48px}
    .sponsors{grid-template-columns:repeat(3,1fr);gap:6px}
    .summary{font-size:14px}
    .card{padding:12px;gap:10px}
  }

  @media (min-width:1024px){
    .wrap{max-width:820px}
  }
</style>
</head>
<body>
  <div class="wrap">

    <!-- HERO -->
    <header class="hero" role="banner" aria-label="Header">
      <div class="hero-left">
        <div class="small">FORM PENGAJUAN LAYANAN</div>
        <div class="big">MOBIL LAYANAN UMAT</div>
        <div class="sub">Pimpinan Cabang Muhammadiyah Wonotunggal</div>
      </div>
      <div class="hero-right" aria-hidden="true">
        <!-- placeholder generic header logo -->
        <img src="logo-header-placeholder.png" alt="Logo MLU">
      </div>
    </header>

    <!-- FORM -->
    <main class="card" role="main">
      <form id="mluForm" autocomplete="on" novalidate>
        <!-- tanggal -->
        <div class="field">
          <div class="icon" aria-hidden="true" style="font-size:22px">
  üìÖ
          </div>
          <div class="control">
            <label for="tanggal">Tanggal</label>
            <input id="tanggal" name="tanggal" type="date" required>
          </div>
        </div>

        <!-- hari (below date) -->
        <div class="field">
          <div class="icon" aria-hidden="true" style="font-size:22px">
  üóìÔ∏è
          </div>
          <div class="control">
            <label for="hariDisplay">Hari (otomatis)</label>
            <input id="hariDisplay" name="hariDisplay" type="text" readonly placeholder="Akan muncul setelah pilih tanggal">
          </div>
        </div>

        <!-- Nama Pemohon -->
        <div class="field">
          <div class="icon" aria-hidden="true" style="font-size:22px">
  üë§</div>
          <div class="control">
            <label for="pemohon">Nama Pemohon</label>
            <input id="pemohon" name="pemohon" type="text" placeholder="" required>
          </div>
        </div>

        <!-- No HP -->
        <div class="field">
          <div class="icon" aria-hidden="true" style="font-size:22px">
  üìû</div>
          <div class="control">
            <label for="hp">No. HP</label>
            <input id="hp" name="hp" type="number" inputmode="tel" placeholder="Contoh: 6281234567890" required>
          </div>
        </div>

        <!-- Nama Pasien -->
        <div class="field">
          <div class="icon" aria-hidden="true" style="font-size:22px">
  ü§í</div>
          <div class="control">
            <label for="pasien">Nama Pasien</label>
            <input id="pasien" name="pasien" type="text" placeholder="" required>
          </div>
        </div>

        <!-- Usia -->
        <div class="field">
          <div class="icon" aria-hidden="true" style="font-size:22px">
  üî¢</div>
          <div class="control">
            <label for="usia">Usia Pasien</label>
            <input id="usia" name="usia" type="number" min="0" placeholder="tahun" required>
          </div>
        </div>

<!-- Kartu Jaminan -->
<div class="field">
  <div class="icon" aria-hidden="true" style="font-size:22px">üí≥</div>
  <div class="control">
    <label for="jaminan">Status Berobat Pasien</label>
    <select id="jaminan" name="jaminan" required>
      <option value="">Pilih Status Berobat</option>
      <option value="BPJS">BPJS</option>
      <option value="UMUM">Umum</option>
    </select>

    <div id="jaminanInfo" class="muted" style="margin-top:6px;display:none;"></div>
  </div>
</div>

        <!-- Alamat jemput -->
        <div class="field">
          <div class="icon" aria-hidden="true" style="font-size:22px">
  üöë</div>
          <div class="control">
            <label for="alamat">Alamat jemput</label>
            <textarea id="alamat" name="alamat" placeholder="Contoh: Jl. Berkemajuan No.12, Desa A RT 19 RW 12" required></textarea>
          </div>
        </div>

        <!-- Tujuan: kategori + dynamic -->
        <div class="field">
          <div class="icon" aria-hidden="true" style="font-size:22px">
  üè•</div>
          <div class="control">
            <label for="kategoriTujuan">Kategori Tujuan</label>
            <div class="inline-row">
              <div class="col">
                <select id="kategoriTujuan" name="kategoriTujuan">
                  <option value="Rumah Sakit">Rumah Sakit</option>
                  <option value="Puskesmas">Puskesmas</option>
                  <option value="Klinik / Praktek Dokter">Klinik / Praktek Dokter</option>
                  <option value="Lainnya">Lainnya</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- dynamic target select -->
        <div class="field" id="tujuanField">
          <div class="icon" aria-hidden="true" style="font-size:22px">
  üè•</div>
          <div class="control">
            <label id="tujuanLabel" for="tujuanSelect">Tempat tujuan</label>
            <select id="tujuanSelect" name="tujuanSelect"></select>
            <input id="tujuanManual" name="tujuanManual" type="text" placeholder="Tulis tujuan jika memilih Lainnya atau Klinik (opsional)" style="display:none;margin-top:8px;">
          </div>
        </div>

        <!-- Jam & Tiba -->
<div class="field">
  <div class="icon" aria-hidden="true" style="font-size:22px">‚è∞</div>

  <div class="control">
    <label for="jam">Jam berangkat</label>
    <select id="jam" name="jam" required>
      <option value="">Pilih Jam Berangkat</option>
    </select>

    <div style="height:8px"></div>

    <label for="tiba" class="muted">Tiba ditujuan (Jam berapa harus sampai)</label>
    <select id="tiba" name="tiba" required>
      <option value="">Pilih Jam Tiba</option>
    </select>
  </div>
</div>
        <!-- Jenis penyakit (wajib) -->
        <div class="field">
          <div class="icon" aria-hidden="true" style="font-size:22px">ü©∫</div>
          <div class="control">
            <label for="penyakit">Penyakit</label>
            <input id="penyakit" name="penyakit" type="text" placeholder="Contoh: demam / sesak napas" required>
          </div>
        </div>

        <!-- Posisi Pasien -->
<div class="field">
  <div class="icon" aria-hidden="true" style="font-size:22px">
    üõèÔ∏è
  </div>
  <div class="control">
    <label for="posisi">Posisi Pasien</label>
    <select id="posisi" name="posisi">
      <option value="Duduk">Duduk</option>
      <option value="Baring">Baring</option>
    </select>
  </div>
</div>
<!-- Jumlah Pendamping -->
<div class="field">
  <div class="icon" aria-hidden="true" style="font-size:22px">
    üë•
  </div>
  <div class="control">
    <label for="pendamping">Jumlah Pendamping</label>
    <input
      id="pendamping"
      name="pendamping"
      type="number"
      min="0"
      placeholder="Contoh: 1" required>
  </div>
</div>

        <!-- Keterangan -->
        <div class="field">
          <div class="icon" aria-hidden="true" style="font-size:22px">
  üìù</div>
          <div class="control">
            <label for="keterangan">Keterangan (opsional)</label>
            <textarea id="keterangan" name="keterangan" placeholder="Opsional: rute, kebutuhan khusus (butuh Oksigen), catatan untuk driver"></textarea>
          </div>
        </div>

        <div class="actions">
  <div class="field persetujuan-box">
    <div class="control">
      <label>
        <input type="checkbox" id="persetujuan" required>
        Saya menyatakan bahwa seluruh data yang saya isikan telah sesuai
        dengan kondisi sebenarnya, serta memahami dan bersedia mengikuti
        pedoman layanan Mobil Layanan Umat PCM Wonotunggal.
      </label>

      <div style="margin-top:6px;font-size:13px">
        <a href="https://s.id/pedomanmobillayananmu" target="_blank">
          <strong>üìÑ Baca Pedoman Layanan</strong>
        </a>
      </div>
    </div>
  </div>
</div>

          <button type="button" id="openConfirm" class="btn btn-primary">Kirim & Ajukan</button>
          <button type="button" id="resetBtn" class="btn btn-ghost">Reset</button>
        </div>
      </form>
    </main>

    <!-- Confirm popup -->
    <div class="popup" id="confirmPopup" role="dialog" aria-modal="true">
      <div class="modal">
        <h3>üßæ Konfirmasi Data Pengajuan</h3>
        <p class="muted" style="margin-top:6px">Pastikan seluruh data di bawah ini sudah benar.
Data tidak dapat diubah setelah dikirim.</p>
        <div class="summary" id="confirmSummary" aria-live="polite"></div>
 	<div class="info-box">
  <div class="info-title">‚ö†Ô∏è PERHATIAN</div>
  <div class="info-text">
    Setelah menekan tombol <strong>‚ÄúYakin & Kirim‚Äù</strong>:
    <ol>
      <li><strong>WhatsApp akan terbuka otomatis</strong> üì≤</li>
      <li>Periksa kembali pesan yang muncul</li>
      <li>Tekan tombol <strong>KIRIM</strong> di WhatsApp untuk menyelesaikan permohonan</li>
    </ol>
    <div class="info-note">
      Jika WhatsApp tidak terbuka, pastikan aplikasi WhatsApp sudah terpasang di perangkat Anda.
    </div>
  </div>
</div>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
          <button id="confirmEdit" class="btn btn-ghost">üîÑ Cek Lagi</button>
          <button id="confirmSend" class="btn btn-primary">‚úÖ Yakin & Kirim</button>
        </div>
      </div>
    </div>

    <div class="toast" id="successToast">‚úÖ Pengajuan Anda berhasil dikirim! Admin akan menghubungi Anda.</div>

    <!-- footer sponsors -->
    <footer>
      <div style="font-weight:800">Didukung oleh:</div>
      <div class="sponsors">
        <div class="sponsor-slot"><img src="logo-sponsor-1.png" alt="Sponsor 1"></div>
        <div class="sponsor-slot"><img src="logo-sponsor-2.png" alt="Sponsor 2"></div>
        <div class="sponsor-slot"><img src="logo-sponsor-3.png" alt="Sponsor 3"></div>
        <div class="sponsor-slot"><img src="logo-sponsor-4.png" alt="Sponsor 4"></div>
        <div class="sponsor-slot"><img src="logo-sponsor-5.png" alt="Sponsor 5"></div>
        <div class="sponsor-slot"><img src="logo-sponsor-6.png" alt="Sponsor 6"></div>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:12px">¬© PCM Wonotunggal ‚Ä¢ Mobil Layanan Umat</div>
    </footer>

  </div>

<script>
  // CONFIG
  const ADMIN_PHONE = '6285111521912'; // 085111521912 (hidden in UI)
  const FORM_ENDPOINT ='https://script.google.com/macros/s/AKfycbwZTGYdZZpzyBo2-Q2yPnAbfc1Zqi5jERPvG7dNwJ3-ylyTYzWgodzJuUV4t36mFUI4/exec'; // optional: Google Apps Script URL to store entries

  // ===============================
  // DATABASE TUJUAN (update terbaru)
  // ===============================

  const RS_LIST = [
    'RS QIM Batang',
    'RSUD Batang',
    'RSUP Karyadi Semarang',
    'RSO Soeharso Solo',
    'RSI Pekajangan',
    'RS Bendan Pekalongan',
    'RS ARO Pekalongan',
    'RS Siti Khotijah Pekalongan',
    'RS Kraton Pekalongan',
    'RS H.A Zaky Djunaid Pekalongan',
    'RS Telogorejo Semarang',
    'RS Hermina Pekalongan'
  ];

  const PUSKESMAS_LIST = [
    'Puskesmas Wonotunggal',
    'Rumah Bersalin Wonotunggal',
    'Puskesmas Bandar 1'
  ];

  const KLINIK_LIST = [
    'Klinik Sidayu Medical Center Bandar',
    'Klinik Anugrah Husada Bandar',
    'Praktek Dokter Dody Bandar',
    'Praktek Dokter Broto Warungasem',
    'Praktek Dokter Nurbaah Batang',
    'Praktek Dokter Andirio Batang',
    'Praktek Dokter Ibrahim Batang'
  ];

  // ===============================
  // DOM & FUNGSI FORM
  // ===============================

  const kategoriTujuan = document.getElementById('kategoriTujuan');
  const tujuanSelect = document.getElementById('tujuanSelect');
  const tujuanManual = document.getElementById('tujuanManual');
  const tujuanLabel = document.getElementById('tujuanLabel');
  const tanggal = document.getElementById('tanggal');
  const hariDisplay = document.getElementById('hariDisplay');

  const form = document.getElementById('mluForm');
  const openConfirm = document.getElementById('openConfirm');
  const resetBtn = document.getElementById('resetBtn');
  const confirmPopup = document.getElementById('confirmPopup');
  const confirmSummary = document.getElementById('confirmSummary');
  const confirmEdit = document.getElementById('confirmEdit');
  const confirmSend = document.getElementById('confirmSend');
  const successToast = document.getElementById('successToast');

  const DAYS = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  const MONTHS = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];

// ===============================
// GENERATE ID PERMOHONAN (ONLINE)
// Format: O-1912-1725-XXXX
// ===============================
function generateIDPermohonan() {
  const random = Math.floor(1000 + Math.random() * 9000); // 4 digit
  return `O-1912-1725-${random}`;
}

  function formatDateDisplay(dateObj){
    const d = dateObj.getDate();
    const m = MONTHS[dateObj.getMonth()];
    const y = dateObj.getFullYear();
    return `${d} ${m} ${y}`;
  }
  function getDayName(dateObj){ return DAYS[dateObj.getDay()]; }

  // populate tujuan select based on category
  function populateTujuan(category){
    tujuanSelect.innerHTML = '';
    tujuanManual.style.display = 'none';
    if(category === 'Rumah Sakit'){
      tujuanLabel.textContent = 'Pilih Rumah Sakit';
      RS_LIST.forEach(r => { const opt = document.createElement('option'); opt.value = r; opt.textContent = r; tujuanSelect.appendChild(opt); });
    } else if(category === 'Puskesmas'){
    const optLabel = document.createElement('option');
    optLabel.disabled = true;
    optLabel.textContent = 'Daftar Puskesmas';
    tujuanSelect.appendChild(optLabel);
      tujuanLabel.textContent = 'Pilih Puskesmas';
      PUSKESMAS_LIST.forEach(r => { const opt = document.createElement('option'); opt.value = r; opt.textContent = r; tujuanSelect.appendChild(opt); });
    } else if(category === 'Klinik / Praktek Dokter' || category === 'Klinik'){
      tujuanLabel.textContent = 'Pilih Klinik / Praktek Dokter';
      KLINIK_LIST.forEach(r => { const opt = document.createElement('option'); opt.value = r; opt.textContent = r; tujuanSelect.appendChild(opt); });
    } else {
      tujuanLabel.textContent = 'Tujuan (tulis manual)';
      tujuanSelect.style.display = 'none';
      tujuanManual.style.display = 'block';
      return;
    }

    // tambahkan opsi "Lainnya"
    const other = document.createElement('option');
    other.value = 'Lainnya';
    other.textContent = 'Lainnya (tulis manual)';
    tujuanSelect.appendChild(other);
    tujuanSelect.style.display = 'block';
  }

  // inisialisasi default
  populateTujuan(kategoriTujuan.value);

  kategoriTujuan.addEventListener('change', (e) => {
    if (e.target.value === 'Lainnya') {
      tujuanSelect.style.display = 'none';
      tujuanManual.style.display = 'block';
    } else {
      populateTujuan(e.target.value);
      tujuanManual.style.display = 'none';
    }
  });

  tujuanSelect.addEventListener('change', (e) => {
    if(e.target.value === 'Lainnya'){
      tujuanManual.style.display = 'block';
    } else {
      tujuanManual.style.display = 'none';
    }
  });

  // tanggal -> hari otomatis
  tanggal.addEventListener('change', ()=>{
    if(tanggal.value){
      const dt = new Date(tanggal.value + 'T00:00:00');
      hariDisplay.value = getDayName(dt);
    } else { hariDisplay.value = ''; }
  });

  function buildPayload(){
    const data = new FormData(form);
    let tglText = data.get('tanggal') || '';
    let dayText = '-';
    let dateFormatted = tglText;
    if(tglText){
      const dt = new Date(tglText + 'T00:00:00');
      dayText = getDayName(dt);
      dateFormatted = formatDateDisplay(dt);
    }
    // determine final tujuan text
    let tujuanVal = data.get('tujuanSelect') || '';
    const manual = data.get('tujuanManual') || '';
    if(tujuanVal === 'Lainnya' && manual) tujuanVal = manual;
    else if(!tujuanVal && manual) tujuanVal = manual;

    return {
      hari: dayText,
      tanggal: dateFormatted,
      pemohon: data.get('pemohon') || '-',
      pasien: data.get('pasien') || '-',
      usia: data.get('usia') || '-',
      jaminan: data.get('jaminan') || '-',
      hp: data.get('hp') || '-',
      alamat: data.get('alamat') || '-',
      tujuan: tujuanVal || '-',
      jam: data.get('jam') || '-',
      tiba: data.get('tiba') || '-',
      penyakit: data.get('penyakit') || '-',
      posisi: data.get('posisi') || '-',
      pendamping: data.get('pendamping') || '-',
      keterangan: data.get('keterangan') || '-'
    };
  }

  // confirm flow
  openConfirm.addEventListener('click', ()=>{
  if (!document.getElementById('persetujuan').checked) {
    alert('Mohon menyetujui ketentuan layanan terlebih dahulu.');
    return;
  }
    const required = ['pemohon','pasien','usia','hp','alamat','tanggal','jam','tiba','penyakit','pendamping','jaminan'];
    for(const id of required){
      const el = document.getElementById(id);
      if(!el || !el.value){
        el && el.focus();
        alert('Masih ada kolom belum terisi. Mohon lengkapi semua kolom yang wajib.');
        return;
      }
    }
    const payload = buildPayload();
confirmSummary.innerHTML = `
  <div class="summary-section">
    <div class="summary-title">üìÖ Jadwal Layanan</div>
    <div class="summary-item"><b>Hari:</b> ${payload.hari}</div>
    <div class="summary-item"><b>Tanggal:</b> ${payload.tanggal}</div>
  </div>

  <div class="summary-section">
    <div class="summary-title">üë§ Data Pemohon & Pasien</div>
    <div class="summary-item"><b>Nama Pemohon:</b> ${payload.pemohon}</div>
    <div class="summary-item"><b>Nama Pasien:</b> ${payload.pasien}</div>
    <div class="summary-item"><b>Usia:</b> ${payload.usia} tahun</div>
    <div class="summary-item"><b>No. HP:</b> ${payload.hp}</div>
  </div>

  <div class="summary-section">
    <div class="summary-title">üöë Rute & Waktu</div>
    <div class="summary-item"><b>Alamat Jemput:</b><br>${payload.alamat}</div>
    <div class="summary-item"><b>Tujuan:</b> ${payload.tujuan}</div>
    <div class="summary-item"><b>Waktu:</b> ${payload.jam} ‚Üí ${payload.tiba}</div>
  </div>

  <div class="summary-section">
    <div class="summary-title">ü©∫ Kondisi Pasien</div>
    <div class="summary-item"><b>Penyakit:</b> ${payload.penyakit}</div>
    <div class="summary-item"><b>Posisi:</b> ${payload.posisi}</div>
    <div class="summary-item"><b>Pendamping:</b> ${payload.pendamping}</div>
    <div class="summary-item"><b>Kartu Jaminan:</b> ${payload.jaminan}</div>
    <div class="summary-item"><b>Keterangan:</b> ${payload.keterangan || '-'}</div>
  </div>
`;

    confirmPopup.classList.add('show');
  });

 confirmEdit.addEventListener('click', () => {
  confirmPopup.classList.remove('show');
});

confirmSend.addEventListener('click', async () => {

  const payload = buildPayload();

  // 1Ô∏è‚É£ BUAT ID PERMOHONAN
  const idPermohonan = generateIDPermohonan();

  // 2Ô∏è‚É£ SUSUN PESAN WHATSAPP
  const lines = [
  '*FORM PERMOHONAN LAYANAN*',
  '*MOBIL LAYANAN UMAT*',
  '*Muhammadiyah Wonotunggal*',
 `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
  `*ID Permohonan :* *${idPermohonan}*`,
  `*Hari / Tanggal :* *${payload.hari}, ${payload.tanggal}*`,
  '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
  '*DATA PASIEN*',
  `> Nama Pemohon : *${payload.pemohon}*`,
  `> Nama Pasien : *${payload.pasien}*`,
  `> Usia : *${payload.usia} tahun*`,
  `> WhatsApp : *${payload.hp}*`,
  '',
  '*RUTE & WAKTU*',
  `> Titik Jemput : *${payload.alamat}*`,
  `> Tujuan : *${payload.tujuan}*`,
  `> Berangkat  : *${payload.jam}*`,
  `> Tiba di Tujuan : *${payload.tiba}*`,
  '',
  '*INFORMASI TAMBAHAN*',
  `> Penyakit : *${payload.penyakit}*`,
  `> Posisi Pasien : *${payload.posisi}*`,
  `> Pendamping : *${payload.pendamping} orang*`,
  `> Keterangan : *${payload.keterangan || '-'}*`,
  '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
  '*PERNYATAAN PERSETUJUAN*',
  'Saya menyatakan bahwa seluruh data yang saya isikan telah sesuai dengan kondisi sebenarnya, serta memahami dan bersedia mengikuti pedoman layanan Mobil Layanan Umat PCM Wonotunggal.',
  '---------',
  '_Pesan ini dikirim otomatis melalui sistem Mobil Layanan Umat PCM Wonotunggal_',
];


  // 3Ô∏è‚É£ BUKA WHATSAPP (HARUS PERTAMA)
  const waText = encodeURIComponent(lines.join('\n'));
  window.open(`https://wa.me/${ADMIN_PHONE}?text=${waText}`, '_blank');


  // =============================
  // 2Ô∏è‚É£ KIRIM KE GOOGLE SHEET (BACKGROUND)
  // =============================
  if (FORM_ENDPOINT) {
    const fd = new FormData(form);
    fd.append('tujuan', payload.tujuan);
    fd.append('hari', payload.hari);
    fd.append('tanggal_formatted', payload.tanggal);
    fd.append('idPermohonan', idPermohonan);

    fetch(FORM_ENDPOINT, {
      method: 'POST',
      body: fd
    })
    .then(res => res.json())
    .then(result => console.log('No Reg:', result.reg))
    .catch(err => console.warn(err));
  }

  // =============================
  // 3Ô∏è‚É£ TUTUP POPUP & RESET
  // =============================
  confirmPopup.classList.remove('show');
  showToast();
  form.reset();
  hariDisplay.value = '';
  populateTujuan(kategoriTujuan.value);

  confirmSend.disabled = false;
  confirmSend.textContent = '‚úÖ Yakin & Kirim';
  });

  resetBtn.addEventListener('click', ()=>{ if(confirm('Reset semua field?')){ form.reset(); hariDisplay.value=''; populateTujuan(kategoriTujuan.value); } });

  function showToast(){ const t = document.getElementById('successToast'); t.classList.add('show'); setTimeout(()=> t.classList.remove('show'),6000); }

  // accessibility
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') confirmPopup.classList.remove('show'); });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const lembaga = document.getElementById("lembaga");
  const box = document.getElementById("lembagaManualBox");
  const input = document.getElementById("lembaga_manual");

  lembaga.addEventListener("change", function () {
    if (this.value === "lainnya") {
      box.style.display = "block";
      input.required = true;
    } else {
      box.style.display = "none";
      input.required = false;
      input.value = "";
    }
  });
});
</script>
<script>
function generateTimeOptions(selectId, startHour = 5) {
  const select = document.getElementById(selectId);
  if (!select) return;

  for (let i = 0; i < 24; i++) {
    const h = (startHour + i) % 24;

    for (let m = 0; m < 60; m += 15) {
      const hh = String(h).padStart(2,'0');
      const mm = String(m).padStart(2,'0');

      const opt = document.createElement('option');
      opt.value = `${hh}:${mm}`;
      opt.textContent = `${hh}:${mm}`;
      select.appendChild(opt);
    }
  }
}

generateTimeOptions('jam', 5);
generateTimeOptions('tiba', 5);
</script>
<script>
function timeToMinutes(t) {
  const [h, m] = t.split(':').map(Number);
  return h * 60 + m;
}

document.getElementById('jam').addEventListener('change', () => {
  document.getElementById('tiba').value = '';
});

document.getElementById('tiba').addEventListener('change', function () {
  const jam = document.getElementById('jam').value;
  if (!jam) return;

  if (timeToMinutes(this.value) <= timeToMinutes(jam)) {
    alert('Jam tiba harus lebih besar dari jam berangkat');
    this.value = '';
  }
});
</script>
<script>
const jaminan = document.getElementById('jaminan');
const jaminanInfo = document.getElementById('jaminanInfo');

jaminan.addEventListener('change', function () {
  if (this.value === 'BPJS') {
    jaminanInfo.style.display = 'block';
    jaminanInfo.textContent =
      'Informasi ini hanya untuk pendataan. Pasien tetap kami layani tanpa membedakan jenis berobat.';
  } 
  else if (this.value === 'UMUM') {
    jaminanInfo.style.display = 'block';
    jaminanInfo.textContent =
      'Informasi ini hanya untuk pendataan. Pasien tetap kami layani tanpa membedakan jenis berobat.';
  } 
  else {
    jaminanInfo.style.display = 'none';
    jaminanInfo.textContent = '';
  }
});
</script>
</body>
</html>
